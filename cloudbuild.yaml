# === Cloud Build config: build + push + deploy ===
# Evita el error de logs: no usa bucket, solo Cloud Logging.
options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: "us-west1"
  _SERVICE: "next-chat"
  _REPO: "app"
  _RUNTIME_SA: "tangible-climate-aura@tangible-climate-aura.iam.gserviceaccount.com"

steps:
  # 1) Build de la imagen usando tu Dockerfile de la ra√≠z
  - name: "gcr.io/cloud-builders/docker"
    args:
      ["build","-t","us-west1-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA","."]

  # 2) Push a Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      ["push","us-west1-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"]

  # 3) Deploy a Cloud Run (en us-west1) usando esa imagen
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      [
        "run","deploy","${_SERVICE}",
        "--region","${_REGION}",
        "--image","us-west1-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA",
        "--allow-unauthenticated",
        "--service-account","${_RUNTIME_SA}",
        "--set-secrets","OPENAI_API_KEY=OPENAI_API_KEY:latest",
        "--set-secrets","OPENAI_ASSISTANT_ID=OPENAI_ASSISTANT_ID:latest"
      ]

images:
  - "us-west1-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"
